# Cosense Export Webアプリ — 仕様書 v0.1

## 1. システム構成

```
[Browser] ──HTTP──► [Fresh API (/export /preview)] ──► Cosense API
   ▲                                   │
   │ ZIP (stream)                      │ fetch /images
   │ JSON (preview)                    ▼
[KV Storage] ◄───────────────┘ (履歴メタ/TTL30d)
```

- **フロント**: React (Vite) + Tailwind + Framer Motion
- **バックエンド**: Deno + Fresh 1.8
- **データストア**: Deno KV

## 2. 画面仕様

| 画面    | コンポーネント           | 主な props / state                 |
| ----- | ----------------- | -------------------------------- |
| トップ   | `<ExportForm>`    | project, sid, isLoading          |
| プレビュー | `<PreviewModal>`  | fileTree, activeFile, onDownload |
| 履歴    | `<HistoryPage>`   | records[], onPreview, onRetry    |
| 設定    | `<SettingsModal>` | prefs, savePrefs                 |

### 2.1 `<ExportForm>`

```tsx
interface ExportFormProps {
  onPreview: (project: string, sid?: string) => void;
  onExport:  (project: string, sid?: string) => void;
}
```

### 2.2 `<PreviewModal>` ツリービュー構造

```ts
interface FileNode {
  path: string;     // "docs/spec.md"
  type: 'file' | 'dir';
  size?: number;    // bytes
  children?: FileNode[];
}
```

## 3. API 設計

| メソッド | パス             | Body                | 応答                                     | 説明              |
| ---- | -------------- | ------------------- | -------------------------------------- | --------------- |
| POST | `/api/preview` | `{ project, sid? }` | `200 OK` JSON { fileTree, sampleHtml } | ZIP を生成せず構造のみ返す |
| POST | `/api/export`  | `{ project, sid? }` | `200 OK` `application/zip` stream      | ZIP を即時返却       |

### 3.1 エラーレスポンス

```json
{
  "error": {
    "code": "COSENSE_NOT_FOUND",
    "message": "Project not found or private without sid"
  }
}
```

HTTP は常に 200、アプリレベル code で区別。

## 4. ドメインモデル (KV)

| Key パターン      | 値                                        | TTL |
| ------------- | ---------------------------------------- | --- |
| `hist:{uuid}` | { id, project, status, size, createdAt } | 30d |

## 5. 主要モジュール

| モジュール         | 説明                                          |
| ------------- | ------------------------------------------- |
| `cosense.ts`  | fetchPages(project, sid?) → Page[]          |
| `markdown.ts` | toMarkdown(page) → string, rewriteLinks(md) |
| `zip.ts`      | streamZip(files: File[])                    |
| `history.ts`  | save(record), list(), remove(id)            |

## 6. アルゴリズムフロー

1. **/preview**
   1. fetchPages → parse → build fileTree
   2. レスポンスに sampleHtml（README.md の先頭 1kB を HTML 化）
2. **/export**
   1. fetchPages→Markdown 化→画像取得
   2. 相対リンク書換
   3. ZIP ストリーム作成 → レスポンス
   4. 履歴保存

## 7. エラー処理方針

| ケース      | エラーコード              | 対応 UI          |
| -------- | ------------------- | -------------- |
| プロジェクト無  | COSENSE\_NOT\_FOUND | トースト赤, 再入力促し   |
| sid 無効   | AUTH\_FAILED        | トースト赤, sid 再入力 |
| 画像取得失敗   | IMG\_FETCH\_ERR     | トースト黄, 続行可 │   |
| ZIP 生成失敗 | ZIP\_FAIL           | トースト赤          |

## 8. ロギング

- `/export` 成功時: project, size, duration, user‑agent
- 失敗時: errorCode, stacktrace (stderr)

## 9. デプロイ & CI

1. GitHub push → `deno task check && deno task fmt` → `deploy.yml`
2. Deno Deploy Free へ auto‑deploy
3. Playwright CI (`e2e.yml`): /, /history, preview modal assertions

---

作成日: 2025‑06‑22

